version: 0.1
component: build
timeoutInSeconds: 20000
runAs: root
shell: bash
env:
  # exportedVariables are made available to use as parameters in sucessor Build Pipeline stages
  # For this Build to run, the Build Pipeline needs to have a BUILDRUN_HASH parameter set
  exportedVariables:
    - JAVA_HOME
steps:
  - type: Command
    name: "Pre-yum repo checks"
    command: |
      ls -alh /etc/yum.repos.d/
      ls -alh /etc/pki/rpm-gpg/
  - type: Command
    name: "Temporary workaround: Set up the yum repo"
    command: |
      ##### BEGIN: Temporary workaround. This step will move to the build runner.
      (echo -e '[ol7_oci_included]' && \
      echo 'name=Oracle Software for OCI users on Oracle Linux $releasever ($basearch)' && \
      echo 'baseurl=https://yum-phx.oracle.com/repo/OracleLinux/OL7/oci/included/\$basearch/' && \
      echo 'gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-oracle' && \
      echo 'gpgcheck=1' && \
      echo 'enabled=1') > /etc/yum.repos.d/oci-included-ol7.repo
      yum-config-manager --enable ol7_optional_latest
      ## yum-config-manager --enable ol7_oci_included
      ##### END: Temporary workaround. This step will move to the build runner.
  - type: Command
    name: "Post-yum repo checks"
    command: |
      ls -alh /etc/yum.repos.d/
  - type: Command
    name: "Install GraalVM Enterprise 22.1 Java 17 - JDK and Native Image"
    command: |
      yum -y install graalvm22-ee-17-native-image
  - type: Command
    name: "Set the JAVA_HOME and PATH"
    command: |
      export JAVA_HOME=/usr/lib64/graalvm/graalvm22-ee-java17
      export PATH=$JAVA_HOME/bin:$PATH
  - type: Command
    name: "Post-install checks"
    command: |
      echo "JAVA_HOME: $JAVA_HOME"
      echo "PATH: $PATH"
      echo "Which Java: $(which java)"
      echo "Java version: $(java -version)"
      echo "Native-image version: $(native-image --version)"
      echo "Maven version: $(mvn --version)"
      echo "Current dir: $(pwd)"
      echo "Current dir contents: $(ls -alh)"
  - type: Command
    name: "Build the JAR"
    command: |
      mvn --no-transfer-progress clean package
  - type: Command
    name: "Run the JAR"
    command: |
      echo "JAVA_HOME: $JAVA_HOME"
      echo "PATH: $PATH"
      echo "Which Java: $(which java)"
      echo "Java version: $(java -version)"
      $JAVA_HOME/bin/java -jar target/my-app-1.0-SNAPSHOT.jar
  - type: Command
    name: "Run mvn clean to remove all generated build files"
    command: |
      mvn clean
  - type: Command
    name: "Build the native executable"
    command: |
      mvn --no-transfer-progress clean -Pnative -DskipTests package
  - type: Command
    name: "Run the native executable"
    command: |
      ./target/my-app
outputArtifacts:
  - name: "App native executable"
    type: BINARY
    location: target/my-app